<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>WeightFoldingCopier.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>WeightFoldingCopier.hpp</h1><a href="WeightFoldingCopier_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <font class="comment">//</font>
00003 <font class="comment">// WeightFoldingCopier</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// 17 September 2004 -- tds</font>
00006 <font class="comment">//</font>
00007 
00008 <font class="preprocessor">#ifndef INDRI_WEIGHTFOLDINGCOPIER_HPP</font>
00009 <font class="preprocessor"></font><font class="preprocessor">#define INDRI_WEIGHTFOLDINGCOPIER_HPP</font>
00010 <font class="preprocessor"></font>
<a name="l00011"></a><a class="code" href="classWeightFoldingCopier.html">00011</a> <font class="keyword">class </font><a class="code" href="classWeightFoldingCopier.html">WeightFoldingCopier</a> : <font class="keyword">public</font> indri::lang::Copier {
00012 <font class="keyword">private</font>:
<a name="l00013"></a><a class="code" href="classWeightFoldingCopier.html#o0">00013</a>   std::vector&lt;indri::lang::Node*&gt; <a class="code" href="classWeightFoldingCopier.html#o0">_nodes</a>;
00014 
00015 <font class="keyword">public</font>:
<a name="l00016"></a><a class="code" href="classWeightFoldingCopier.html#a0">00016</a>   <a class="code" href="classWeightFoldingCopier.html#a0">~WeightFoldingCopier</a>() {
00017     <a class="code" href="delete__range_8hpp.html#a0">delete_vector_contents</a>( <a class="code" href="classWeightFoldingCopier.html#o0">_nodes</a> );
00018   }
00019 
<a name="l00020"></a><a class="code" href="classWeightFoldingCopier.html#a1">00020</a>   <a class="code" href="classindri_1_1lang_1_1Node.html">indri::lang::Node</a>* <a class="code" href="classWeightFoldingCopier.html#a1">defaultAfter</a>( <a class="code" href="classindri_1_1lang_1_1Node.html">indri::lang::Node</a>* old, <a class="code" href="classindri_1_1lang_1_1Node.html">indri::lang::Node</a>* newNode ) {
00021     <a class="code" href="classWeightFoldingCopier.html#o0">_nodes</a>.push_back( newNode );
00022     <font class="keywordflow">return</font> newNode;
00023   }
00024 
<a name="l00025"></a><a class="code" href="classWeightFoldingCopier.html#a2">00025</a>   <a class="code" href="classindri_1_1lang_1_1Node.html">indri::lang::Node</a>* <a class="code" href="classWeightFoldingCopier.html#a2">after</a>( <a class="code" href="classindri_1_1lang_1_1WeightNode.html">indri::lang::WeightNode</a>* oldWeightNode, <a class="code" href="classindri_1_1lang_1_1WeightNode.html">indri::lang::WeightNode</a>* newWeightNode ) {
00026     <a class="code" href="classindri_1_1lang_1_1WeightNode.html">indri::lang::WeightNode</a>* newerWeightNode = <font class="keyword">new</font> <a class="code" href="classindri_1_1lang_1_1WeightNode.html">indri::lang::WeightNode</a>();
00027     <font class="keyword">const</font> std::vector&lt; std::pair&lt;double, indri::lang::ScoredExtentNode*&gt; &gt;&amp; children = newWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1WeightedCombinationNode.html#a0">getChildren</a>();
00028     
00029     <font class="keywordflow">for</font>( size_t i=0; i&lt;children.size(); i++ ) {
00030       <font class="comment">// is this a weight node?</font>
00031       indri::lang::WeightNode* childWeightNode = dynamic_cast&lt;indri::lang::WeightNode*&gt;( children[i].second );
00032 
00033       <font class="comment">// is this a combine node?</font>
00034       <a class="code" href="classindri_1_1lang_1_1CombineNode.html">indri::lang::CombineNode</a>* childCombineNode = dynamic_cast&lt;indri::lang::CombineNode*&gt;( children[i].second );
00035 
00036       <font class="keywordflow">if</font>( !childWeightNode &amp;&amp; !childCombineNode ) {
00037         <font class="comment">// child is not a weight node, so just add it directly</font>
00038         newerWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1WeightedCombinationNode.html#a1">addChild</a>( children[i].first, children[i].second );
00039       } <font class="keywordflow">else</font> <font class="keywordflow">if</font>( childCombineNode ) {
00040         <font class="keyword">const</font> std::vector&lt; indri::lang::ScoredExtentNode* &gt;&amp; grandkids = childCombineNode-&gt;<a class="code" href="classindri_1_1lang_1_1UnweightedCombinationNode.html#a0">getChildren</a>();
00041         <font class="keywordtype">double</font> kidWeight = children[i].first / double(grandkids.size());
00042         
00043         <font class="keywordflow">for</font>( size_t j=0; j&lt;grandkids.size(); j++ ) {
00044           newerWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1WeightedCombinationNode.html#a1">addChild</a>( kidWeight, grandkids[j] );
00045         }
00046       } <font class="keywordflow">else</font> {
00047         <font class="comment">// child _is_ a weight node, so we're going to fold all its children up to this level</font>
00048         <font class="keyword">const</font> std::vector&lt; std::pair&lt;double, indri::lang::ScoredExtentNode*&gt; &gt;&amp; grandkids = childWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1WeightedCombinationNode.html#a0">getChildren</a>();
00049         <font class="keywordtype">double</font> parentWeight = children[i].first;
00050         <font class="keywordtype">double</font> normalizer = 0.0;
00051 
00052         <font class="comment">// need to normalize all weights to sum to 1</font>
00053         <font class="keywordflow">for</font>( size_t j=0; j&lt;grandkids.size(); j++ ) {
00054           normalizer += grandkids[j].first;
00055         }
00056     
00057         <font class="keywordflow">for</font>( size_t j=0; j&lt;grandkids.size(); j++ ) {
00058           <font class="comment">// have to normalize the weight by including the parent weight as well</font>
00059           newerWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1WeightedCombinationNode.html#a1">addChild</a>( parentWeight * grandkids[j].first / normalizer,
00060                                      grandkids[j].second );
00061         }
00062       }
00063     }
00064 
00065     newerWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1Node.html#a2">setNodeName</a>( newWeightNode-&gt;<a class="code" href="classindri_1_1lang_1_1Node.html#a3">nodeName</a>() );
00066     <font class="keyword">delete</font> newWeightNode;
00067     <a class="code" href="classWeightFoldingCopier.html#o0">_nodes</a>.push_back( newerWeightNode );
00068 
00069     <font class="keywordflow">return</font> newerWeightNode;
00070   }
00071 };
00072 
00073 <font class="preprocessor">#endif // INDRI_WEIGHTFOLDINGCOPIER_HPP</font>
00074 <font class="preprocessor"></font>
</pre></div><hr><address align="right"><small>Generated on Tue Nov 16 15:17:23 2004 for INDRI by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.16 </small></address>
</body>
</html>
