<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DocListDiskBlockReader.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>DocListDiskBlockReader.hpp</h1><a href="DocListDiskBlockReader_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*==========================================================================</font>
00002 <font class="comment">  Copyright (c) 2004 University of Massachusetts.  All Rights Reserved.</font>
00003 <font class="comment"></font>
00004 <font class="comment">  Use of the Lemur Toolkit for Language Modeling and Information Retrieval</font>
00005 <font class="comment">  is subject to the terms of the software license set forth in the LICENSE</font>
00006 <font class="comment">  file included with this software, and also available at</font>
00007 <font class="comment">  http://www.cs.cmu.edu/~lemur/license.html </font>
00008 <font class="comment">  as well as the conditions below.</font>
00009 <font class="comment"></font>
00010 <font class="comment">  Redistribution and use in source and binary forms, with or without</font>
00011 <font class="comment">  modification, are permitted provided that the following conditions</font>
00012 <font class="comment">  are met:</font>
00013 <font class="comment"></font>
00014 <font class="comment">  1. Redistributions of source code must retain the above copyright</font>
00015 <font class="comment">  notice, this list of conditions and the following disclaimer.</font>
00016 <font class="comment"></font>
00017 <font class="comment">  2. Redistributions in binary form must reproduce the above copyright</font>
00018 <font class="comment">  notice, this list of conditions and the following disclaimer in</font>
00019 <font class="comment">  the documentation and/or other materials provided with the</font>
00020 <font class="comment">  distribution.</font>
00021 <font class="comment"></font>
00022 <font class="comment">  3. The names "Indri", "Center for Intelligent Information Retrieval", </font>
00023 <font class="comment">  "CIIR", and "University of Massachusetts" must not be used to</font>
00024 <font class="comment">  endorse or promote products derived from this software without</font>
00025 <font class="comment">  prior written permission. To obtain permission, contact</font>
00026 <font class="comment">  indri-info@ciir.cs.umass.edu.</font>
00027 <font class="comment"></font>
00028 <font class="comment">  4. Products derived from this software may not be called "Indri" nor </font>
00029 <font class="comment">  may "Indri" appear in their names without prior written permission of </font>
00030 <font class="comment">  the University of Massachusetts. To obtain permission, contact </font>
00031 <font class="comment">  indri-info@ciir.cs.umass.edu.</font>
00032 <font class="comment"></font>
00033 <font class="comment">  THIS SOFTWARE IS PROVIDED BY THE UNIVERSITY OF MASSACHUSETTS AND OTHER</font>
00034 <font class="comment">  CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,</font>
00035 <font class="comment">  BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND</font>
00036 <font class="comment">  FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL</font>
00037 <font class="comment">  THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</font>
00038 <font class="comment">  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</font>
00039 <font class="comment">  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</font>
00040 <font class="comment">  OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</font>
00041 <font class="comment">  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</font>
00042 <font class="comment">  TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</font>
00043 <font class="comment">  THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</font>
00044 <font class="comment">  DAMAGE.</font>
00045 <font class="comment">  ==========================================================================</font>
00046 <font class="comment">*/</font>
00047 
00048 
00049 <font class="comment">//</font>
00050 <font class="comment">// DocListDiskBlockReader</font>
00051 <font class="comment">//</font>
00052 <font class="comment">// 9 January 2004 - tds</font>
00053 <font class="comment">//</font>
00054 
00055 <font class="preprocessor">#ifndef LEMUR_KEYFILEDOCLISTDISKBLOCKREADER_HPP</font>
00056 <font class="preprocessor"></font><font class="preprocessor">#define LEMUR_KEYFILEDOCLISTDISKBLOCKREADER_HPP</font>
00057 <font class="preprocessor"></font>
<a name="l00058"></a><a class="code" href="DocListDiskBlockReader_8hpp.html#a0">00058</a> <font class="preprocessor">#define INDRI_DOCLIST_BLOCKSIZE (8192)</font>
00059 <font class="preprocessor"></font><font class="preprocessor">#include "lemur/RVLCompress.hpp"</font>
00060 <font class="preprocessor">#include "<a class="code" href="DocListInfo_8hpp.html">indri/DocListInfo.hpp</a>"</font>
00061 <font class="preprocessor">#include "<a class="code" href="DocumentCount_8hpp.html">indri/DocumentCount.hpp</a>"</font>
00062 
00063 <font class="keyword">namespace </font>indri {
00064   <font class="keyword">namespace </font>index {
00065 
<a name="l00066"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html">00066</a>     <font class="keyword">class </font><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html">DocListDiskBlockReader</a> {
00067     <font class="keyword">private</font>:
<a name="l00068"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">00068</a>       <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a>;
00069 
<a name="l00070"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">00070</a>       <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>;
<a name="l00071"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">00071</a>       <font class="keyword">const</font> <font class="keywordtype">char</font>* <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a>;
<a name="l00072"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">00072</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a>;
<a name="l00073"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">00073</a>       INT16 <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>;
00074 
<a name="l00075"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">00075</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a>;
<a name="l00076"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">00076</a>       INT32 <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a>;
00077 
<a name="l00078"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o7">00078</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o7">_lastTerm</a>;
<a name="l00079"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o8">00079</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o8">_firstTerm</a>;
<a name="l00080"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o9">00080</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o9">_lastDocument</a>;
00081 
<a name="l00082"></a><a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html">00082</a>       <font class="keyword">struct </font><a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html">DocumentData</a> {
<a name="l00083"></a><a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">00083</a>         <font class="keywordtype">int</font> <a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a>;
<a name="l00084"></a><a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">00084</a>         <font class="keywordtype">int</font> <a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a>;
<a name="l00085"></a><a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">00085</a>         <font class="keywordtype">int</font> <a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>[ <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a> ];
00086       } <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>;
00087 
00088     <font class="keyword">public</font>:
<a name="l00089"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a0">00089</a>       <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a0">DocListDiskBlockReader</a>() : <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a>(true) {
00090         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a1">setBlock</a>(0);
00091       }
00092 
<a name="l00093"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#d0">00093</a>       <font class="keyword">static</font> <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#d0">blockSize</a>() {
00094         <font class="keywordflow">return</font> <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>;
00095       }
00096 
<a name="l00097"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a1">00097</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a1">setBlock</a>( <font class="keyword">const</font> <font class="keywordtype">char</font>* block ) {
00098         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> = block;
00099 
00100         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> ? *(<font class="keywordtype">short</font>*) <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> : 0;
00101         
00102         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> = 0;
00103         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <font class="keyword">sizeof</font>(short);
00104         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>;
00105         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> = 0;
00106         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> = 0;
00107 
00108         <font class="keyword">const</font> <font class="keywordtype">char</font>* endBlock = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>;
00109 
00110         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o7">_lastTerm</a> = (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> &gt; 0) ? * (<font class="keywordtype">int</font>*) (endBlock - <font class="keyword">sizeof</font>(int)) : 0;
00111         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o8">_firstTerm</a> = (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> &gt; 0) ? * (<font class="keywordtype">int</font>*) (endBlock - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>*<font class="keyword">sizeof</font>(int)) : 0;
00112         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o9">_lastDocument</a> = 0;
00113 
00114         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> &gt; 0 )
00115           memcpy( &amp;<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o9">_lastDocument</a>, endBlock - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>*(<font class="keyword">sizeof</font>(<font class="keywordtype">int</font>)+<font class="keyword">sizeof</font>(<font class="keywordtype">short</font>)) - <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>), <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>) );
00116 
00117         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> = -1;
00118         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> = (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> == 0);
00119 
00120         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c1">_validateBlock</a>() );
00121       }
00122 
<a name="l00123"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">00123</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">lastTerm</a>() {
00124         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o7">_lastTerm</a>;
00125       }
00126 
<a name="l00127"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a3">00127</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a3">firstTerm</a>() {
00128         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o8">_firstTerm</a>;
00129       }
00130 
<a name="l00131"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">00131</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>() {
00132         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o9">_lastDocument</a>;
00133       }
00134 
<a name="l00135"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a5">00135</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a5">hasMore</a>() {
00136         <font class="keywordflow">return</font> !( (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a>) &amp;&amp; (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> + 1) == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> );
00137       }
00138 
00139     <font class="keyword">private</font>:
<a name="l00140"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">00140</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() {
00141         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> = MAX_INT32;
00142         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> = MAX_INT32;
00143         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>[0] = MAX_INT32;
00144         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00145       }
00146 
<a name="l00147"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c1">00147</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c1">_validateBlock</a>() {
00148         <font class="keywordflow">if</font>( ! <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> )
00149           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00150 
00151         <font class="comment">// validate termCount</font>
00152         <font class="keywordtype">short</font> tc = * (<font class="keywordtype">short</font>*) <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a>;
00153         assert( tc &gt; 0 );
00154         assert( tc &lt; <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a> / <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>) );
00155 
00156         <font class="keyword">const</font> <font class="keywordtype">char</font>* endBlock = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>;
00157         UINT32* termIDs = ( (UINT32*) (<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>) ) - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>;
00158         UINT16* offsets = ( (UINT16*) termIDs ) - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>;
00159         UINT32* lastDoc = ( (UINT32*) offsets ) - 1;
00160         <font class="keywordtype">char</font>* beginMetaData = (<font class="keywordtype">char</font>*) lastDoc;
00161         size_t maxDataLength = beginMetaData - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a>;
00162 
00163         <font class="comment">// validate offsets</font>
00164         <font class="keywordflow">for</font>( <font class="keywordtype">int</font> i=0; i&lt;<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>; i++ ) {
00165           assert( offsets[i] &gt; <font class="keyword">sizeof</font>(<font class="keywordtype">short</font>) );
00166           assert( offsets[i] &lt;= maxDataLength );
00167           <font class="keywordflow">if</font>( i&gt;0 )
00168             assert( offsets[i] &gt; offsets[i-1] );
00169         }
00170 
00171         <font class="comment">// validate termIDs</font>
00172         <font class="keywordflow">for</font>( <font class="keywordtype">int</font> i=0; i&lt;<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>; i++ ) {
00173           assert( termIDs[i] &gt;= 0 );
00174           <font class="keywordflow">if</font>( i&gt;0 )
00175             assert( termIDs[i] &gt; termIDs[i-1] );
00176         }
00177 
00178         <font class="comment">// validate lastDoc</font>
00179         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>() &gt; 0 );
00180         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00181       }
00182 
<a name="l00183"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c2">00183</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c2">_skipDocumentLocations</a>() {
00184         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::skip_ints( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> );
00185       }
00186       
<a name="l00187"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c3">00187</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c3">_fetchDocumentHeader</a>() {
00188         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> &lt; <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> );
00189         <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a>;
00190         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> );
00191         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> );
00192         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> += <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>;
00193         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> + <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> &lt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> );
00194         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> &gt; 0 );
00195         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> &gt;= 0 );
00196       }
00197 
<a name="l00198"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c4">00198</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c4">_fetchDocumentPositions</a>() {
00199         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> &lt; <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> );
00200         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int_count( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> );
00201 
00202         <font class="keywordflow">for</font>( <font class="keywordtype">int</font> i=1; i&lt;<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a>; i++ ) {
00203           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>[i] += <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>[i-1];
00204         }
00205         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> &lt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> );
00206       }
00207 
<a name="l00208"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c5">00208</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c5">_fetchDocument</a>() {
00209         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c3">_fetchDocumentHeader</a>();
00210         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c4">_fetchDocumentPositions</a>();
00211       }
00212 
<a name="l00213"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c6">00213</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c6">_skipToTermIndex</a>( <font class="keywordtype">int</font> index ) {
00214         assert( index &lt; <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> );
00215         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> = index;
00216 
00217         <font class="keyword">const</font> <font class="keywordtype">char</font>* endBlock = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>;
00218         <font class="keyword">const</font> <font class="keywordtype">char</font>* endEndings = endBlock - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>*<font class="keyword">sizeof</font>(INT32);
00219         <font class="keyword">const</font> <font class="keywordtype">char</font>* beginEndings = endBlock - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>*(<font class="keyword">sizeof</font>(INT32)+<font class="keyword">sizeof</font>(INT16));
00220         INT32* termIDs = (INT32*) endEndings;
00221         INT16* offsets = (INT16*) beginEndings;
00222 
00223         <font class="keywordtype">short</font> endOffset = offsets[ <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> ];
00224         <font class="keywordtype">short</font> startOffset;
00225         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> == 0 ) {
00226           startOffset = <font class="keyword">sizeof</font>(short);
00227         } <font class="keywordflow">else</font> {
00228           startOffset = offsets[ <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> - 1 ];
00229         }
00230 
00231         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> = termIDs[ <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> ];
00232         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + startOffset;
00233         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + endOffset;
00234 
00235         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> = 0;
00236         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> = 0;
00237         
00238         <font class="comment">// validate information</font>
00239         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> &lt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> );
00240         assert( startOffset &gt; 0 &amp;&amp; startOffset &lt; <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a> );
00241         assert( endOffset &gt; startOffset &amp;&amp; endOffset &lt; <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a> );
00242         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> &lt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">lastTerm</a>() );
00243         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> &gt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a3">firstTerm</a>() );
00244       }
00245 
<a name="l00246"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c7">00246</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c7">_skipToTerm</a>( <font class="keywordtype">int</font> termID ) {
00247         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> &lt; termID );
00248 
00249         <font class="keywordflow">if</font>( termID &gt; <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">lastTerm</a>() ) {
00250           assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() );
00251           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>;
00252           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> = <font class="keyword">true</font>;
00253           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00254         }
00255 
00256         <font class="comment">// find termID array</font>
00257         <font class="keyword">const</font> <font class="keywordtype">char</font>* endBlock = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> + <a class="code" href="DocListDiskBlockReader_8hpp.html#a0">INDRI_DOCLIST_BLOCKSIZE</a>;
00258         <font class="keyword">const</font> <font class="keywordtype">char</font>* beginTermIDs = endBlock - <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a>*<font class="keyword">sizeof</font>(UINT32);
00259         UINT32* termIDs = (UINT32*) beginTermIDs;
00260         UINT32* start = termIDs;
00261         UINT32* finish = termIDs + <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> - 1;
00262 
00263         <font class="comment">// binary search for the right location  </font>
00264         <font class="keywordflow">while</font>( (finish - start) &gt;= 2 ) {
00265           UINT32* middle = start + (finish-start)/2;
00266 
00267           <font class="keywordflow">if</font>( *middle &gt; unsigned(termID) )
00268             finish = middle;
00269           <font class="keywordflow">else</font>
00270             start = middle;
00271         }
00272         
00273         UINT32* termLocation; 
00274 
00275         <font class="keywordflow">if</font>( *start &gt;= unsigned(termID) )
00276           termLocation = start;
00277         <font class="keywordflow">else</font>
00278           termLocation = finish;
00279 
00280         <font class="comment">// the term isn't here!</font>
00281         <font class="keywordflow">if</font>( *termLocation != unsigned(termID) )
00282           <font class="keywordflow">return</font> <font class="keyword">false</font>;
00283         
00284         <font class="comment">// now, reset everything</font>
00285         assert( (termLocation - termIDs) &lt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> );
00286         assert( *termLocation == <font class="keywordtype">unsigned</font>(termID) );
00287 
00288         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c6">_skipToTermIndex</a>( <font class="keywordtype">int</font>(termLocation - termIDs) );
00289         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00290       }
00291 
00292     <font class="keyword">public</font>:
00293       <font class="comment">// Returns true if the requested (termID, documentID) pair</font>
00294       <font class="comment">// should be in a block after this one.  This </font>
00295       <font class="comment">// method is used for skipping--if this returns false,</font>
00296       <font class="comment">// you can safely skip to the next block in search of this</font>
00297       <font class="comment">// pair.</font>
<a name="l00298"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a6">00298</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a6">before</a>( <font class="keywordtype">int</font> termID, <font class="keywordtype">int</font> documentID ) {
00299         <font class="keywordtype">int</font> last = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">lastTerm</a>();
00300         <font class="keywordtype">int</font> lastDoc = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>();
00301 
00302         <font class="comment">// the first termID in this block is after this one</font>
00303         <font class="comment">// so we're definitely behind</font>
00304         <font class="keywordflow">if</font>( last &lt; termID )
00305           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00306 
00307         <font class="comment">// the last termID in this block is this termID,</font>
00308         <font class="comment">// but the last documentID is smaller than the one</font>
00309         <font class="comment">// we want, so we're still smaller</font>
00310         <font class="keywordflow">if</font>( last == termID &amp;&amp; lastDoc &lt; documentID )
00311           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00312 
00313         assert( last &gt; termID || (termID == last &amp;&amp; lastDoc &gt;= documentID) );
00314         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00315       }
00316 
00317       <font class="comment">// Returns true if the requested (termID, documentID) pair</font>
00318       <font class="comment">// should be in this block.  This </font>
00319       <font class="comment">// method is used for skipping--if this returns false,</font>
00320       <font class="comment">// you can safely skip to the next block in search of this</font>
00321       <font class="comment">// pair.</font>
<a name="l00322"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a7">00322</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a7">contains</a>( <font class="keywordtype">int</font> termID, <font class="keywordtype">int</font> documentID ) {
00323         <font class="keywordtype">int</font> last = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a2">lastTerm</a>();
00324         <font class="keywordtype">int</font> first = <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a3">firstTerm</a>();
00325         
00326         <font class="comment">// the last term is greater than the ID</font>
00327         <font class="comment">// we're searching for, so the document</font>
00328         <font class="comment">// definitely should be here</font>
00329         <font class="keywordflow">if</font>( termID != last )
00330           <font class="keywordflow">return</font> termID &gt;= first &amp;&amp; termID &lt;= last;
00331 
00332         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>() &gt;= documentID;
00333       }
00334 
00335       <font class="comment">// attempt to skip to (termID, documentID)</font>
00336       <font class="comment">// or to a document greater that documentID</font>
00337       <font class="comment">// but that still shares the same termID.</font>
00338       <font class="comment">// return true if successful.</font>
<a name="l00339"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a8">00339</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a8">skip</a>( <font class="keywordtype">int</font> termID, <font class="keywordtype">int</font> documentID ) {
00340         <font class="comment">// attempt to skip to this term</font>
00341         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> &lt; termID ) {
00342           <font class="keywordflow">if</font>( !<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c7">_skipToTerm</a>( termID ) ) {
00343             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00344           } <font class="keywordflow">else</font> <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00345             <font class="comment">// skip to term may have run us off</font>
00346             <font class="comment">// the end of the block, in that</font>
00347             <font class="comment">// case, return false without fetching</font>
00348             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00349           } <font class="keywordflow">else</font> {
00350             <font class="comment">// we moved forward to get here, so</font>
00351             <font class="comment">// we'd better fetch a document</font>
00352             <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c5">_fetchDocument</a>();
00353           }
00354         } <font class="keywordflow">else</font> <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00355           <font class="comment">// if we're out of documents, or if we've</font>
00356           <font class="comment">// come to the next term, tell the caller</font>
00357           <font class="comment">// we were unsuccessful</font>
00358           assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() );
00359           <font class="keywordflow">return</font> <font class="keyword">false</font>;
00360         }
00361 
00362         <font class="comment">// we have a good document, so return success</font>
00363         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> &gt;= documentID )
00364           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00365 
00366         <font class="comment">// keep looking! it has to be here somewhere!</font>
00367         <font class="keywordflow">while</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> != <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00368           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c3">_fetchDocumentHeader</a>();
00369 
00370           <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> &gt;= documentID ) {
00371             <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c4">_fetchDocumentPositions</a>();
00372             <font class="keywordflow">return</font> <font class="keyword">true</font>;
00373           }
00374 
00375           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c2">_skipDocumentLocations</a>();
00376         }
00377 
00378         <font class="comment">// oh, well. no luck</font>
00379         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() );
00380         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00381       }
00382 
<a name="l00383"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a9">00383</a>       <font class="keywordtype">void</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a9">currentDocument</a>( <a class="code" href="classindri_1_1index_1_1DocListInfo.html">DocListInfo</a>&amp; info ) {
00384         assert( ! <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> );
00385         assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> != 0 );
00386 
00387         info.<a class="code" href="classindri_1_1index_1_1DocListInfo.html#a5">setTermID</a>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> );
00388         info.<a class="code" href="classindri_1_1index_1_1DocListInfo.html#a4">setDocID</a>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a> );
00389         <font class="comment">// dmf FIXME</font>
00390         info.<a class="code" href="classindri_1_1index_1_1DocListInfo.html#a7">addPositions</a>((LOC_T*) <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m2">positions</a>, <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m1">positionCount</a> );
00391       }
00392 
<a name="l00393"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a10">00393</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a10">nextDocument</a>() {
00394         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> || <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o0">_block</a> == 0 ) {
00395           assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() );
00396           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> = <font class="keyword">true</font>;
00397           <font class="keywordflow">return</font> <font class="keyword">false</font>;
00398         }
00399 
00400         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00401           <font class="comment">// go to the next term</font>
00402           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a>++;
00403 
00404           <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> &gt;= <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o4">_termCount</a> ) {
00405             assert( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c0">_trashDocument</a>() );
00406             <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a> = <font class="keyword">true</font>;
00407             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00408           }
00409 
00410           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c6">_skipToTermIndex</a>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o3">_termIndex</a> );
00411         }
00412 
00413         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c5">_fetchDocument</a>();
00414         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00415       }
00416 
<a name="l00417"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a11">00417</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a11">readBlock</a>( <font class="keywordtype">int</font> termID, greedy_vector&lt;DocumentCount&gt;&amp; entries ) {
00418         <font class="comment">// skip to this term ID</font>
00419         <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a> != termID ) {
00420           <font class="keywordflow">if</font>( !<a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#c7">_skipToTerm</a>(termID) ) {
00421             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00422           }
00423 
00424           <font class="comment">// we may have skipped to the end of the block;</font>
00425           <font class="comment">// in this case return true without fetching anything</font>
00426           <font class="keywordflow">if</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> == <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00427             <font class="keywordflow">return</font> <font class="keyword">true</font>;
00428           }
00429         }
00430 
00431         <font class="comment">// check to see if we need to update the last entry</font>
00432         <a class="code" href="structDocumentCount.html">DocumentCount</a> pair;
00433         <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a> = 0;
00434         pair.<a class="code" href="structDocumentCount.html#m0">document</a> = 0;
00435         pair.<a class="code" href="structDocumentCount.html#m1">count</a> = 0;
00436 
00437         <font class="comment">// fetch first document</font>
00438         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m0">document</a> );
00439         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m1">count</a> );
00440 
00441         <font class="comment">// special handling for the first document; it may be that the last</font>
00442         <font class="comment">// block had only part of the positions for this document</font>
00443         <font class="keywordflow">if</font>( entries.size() &amp;&amp; entries.back().document == pair.<a class="code" href="structDocumentCount.html#m0">document</a> ) {
00444           entries.back().count += pair.<a class="code" href="structDocumentCount.html#m1">count</a>;
00445         } <font class="keywordflow">else</font> {
00446           entries.push_back( pair );
00447         }
00448 
00449         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::skip_ints( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m1">count</a> );
00450         <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a> = pair.<a class="code" href="structDocumentCount.html#m0">document</a>;
00451 
00452         <font class="keywordflow">while</font>( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> &lt; <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o2">_listEnd</a> ) {
00453           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m0">document</a> );
00454           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::decompress_int( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m1">count</a> );
00455           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a> = RVLCompress::skip_ints( <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o1">_list</a>, pair.<a class="code" href="structDocumentCount.html#m1">count</a> );
00456           pair.<a class="code" href="structDocumentCount.html#m0">document</a> += <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a>;
00457           <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a4">lastDocument</a> = pair.<a class="code" href="structDocumentCount.html#m0">document</a>;
00458 
00459           entries.push_back( pair );
00460         }
00461 
00462         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00463       }
00464 
<a name="l00465"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a12">00465</a>       <font class="keywordtype">bool</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a12">finished</a>() {
00466         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o5">_finished</a>;
00467       }
00468 
<a name="l00469"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a13">00469</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a13">document</a>()<font class="keyword"> const </font>{
00470         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o10">_documentData</a>.<a class="code" href="structindri_1_1index_1_1DocListDiskBlockReader_1_1DocumentData.html#m0">documentID</a>;
00471       }
00472 
<a name="l00473"></a><a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a14">00473</a>       <font class="keywordtype">int</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#a14">term</a>()<font class="keyword"> const </font>{
00474         <font class="keywordflow">return</font> <a class="code" href="classindri_1_1index_1_1DocListDiskBlockReader.html#o6">_termID</a>;
00475       }
00476     };
00477   }
00478 }
00479 
00480 <font class="preprocessor">#endif // LEMUR_KEYFILEDOCLISTDISKBLOCKREADER_HPP</font>
00481 <font class="preprocessor"></font>
00482 
</pre></div><hr><address align="right"><small>Generated on Tue Nov 16 15:17:20 2004 for INDRI by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.16 </small></address>
</body>
</html>
